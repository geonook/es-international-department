# 🔧 Staging 環境變數修正指南
## Corrected Staging Environment Variables

**更新時間**: 2025-09-05  
**目標**: 修正您當前的 staging 環境變數配置  
**狀態**: 🚨 需要立即修正以避免部署失敗  

---

## ❌ **當前問題分析**

### **您目前的配置**:
```env
GOOGLE_CLIENT_ID=YOUR_GOOGLE_CLIENT_ID
GOOGLE_CLIENT_SECRET=YOUR_GOOGLE_CLIENT_SECRET
DATABASE_URL=postgres://user:password@zeabur-db.com:5432/db?schema=es_staging
JWT_SECRET=staging_1234567890abcdefghijklmnopqrstuvwxyz
SMTP_USER=test@example.com          # ❌ 問題：假的示例值
SMTP_PASS=testpassword              # ❌ 問題：假的示例值  
SMTP_HOST=smtp.example.com          # ❌ 問題：假的示例值
NEXTAUTH_URL=https://staging.your-domain.com
NODE_ENV=staging
```

### **🚨 關鍵問題**:
1. **SMTP 假值會導致部署失敗** - 就像我們之前修復的 production 問題
2. **JWT_SECRET 不安全** - 長度不足且使用弱密鑰
3. **缺少必需變數** - NEXTAUTH_SECRET, ALLOWED_ORIGINS 等
4. **EMAIL_PROVIDER 未設定** - 會預設為 smtp 並觸發驗證錯誤

---

## ✅ **修正後的完整配置**

### **立即複製使用的完整環境變數**:

```env
# ==========================================
# 核心環境配置
# ==========================================
NODE_ENV=staging
NEXTAUTH_URL=https://staging.your-domain.com
ALLOWED_ORIGINS=https://staging.your-domain.com

# ==========================================
# 資料庫配置 (保持您的設定)
# ==========================================
DATABASE_URL=postgres://user:password@zeabur-db.com:5432/db?schema=es_staging

# ==========================================
# 安全密鑰 (全新生成，更安全)
# ==========================================
JWT_SECRET=Tr4q2KulnbpxWMsUneujJe/G6M+6lF1N2On6DtAUfDI=
NEXTAUTH_SECRET=QIXalhOBH2bn4i22VC4Pc2e8wg/6mkBh0tRuKsO7hiE=

# ==========================================
# Google OAuth (保持您的設定)
# ==========================================
GOOGLE_CLIENT_ID=YOUR_GOOGLE_CLIENT_ID
GOOGLE_CLIENT_SECRET=YOUR_GOOGLE_CLIENT_SECRET

# ==========================================
# Email 服務 (修復部署問題)
# ==========================================
EMAIL_PROVIDER=disabled

# ==========================================
# 安全配置 (適合 staging 環境)
# ==========================================
RATE_LIMIT_MAX_REQUESTS=500
RATE_LIMIT_WINDOW_MS=900000

# ==========================================
# 系統工具配置
# ==========================================
PRISMA_CLI_TELEMETRY_DISABLED=1

# ==========================================
# Staging 專用除錯配置
# ==========================================
ENABLE_DEBUG_LOGS=true
ENABLE_TEST_FEATURES=true
```

---

## 🔄 **修正步驟**

### **Step 1: 清理問題變數**
**在 Zeabur Staging 服務中刪除以下變數**:
- `SMTP_USER`
- `SMTP_PASS`  
- `SMTP_HOST`

### **Step 2: 更新現有變數**
**修改以下變數的值**:
- `JWT_SECRET` → `Tr4q2KulnbpxWMsUneujJe/G6M+6lF1N2On6DtAUfDI=`

### **Step 3: 添加新變數**
**添加以下缺失的變數**:
```env
NEXTAUTH_SECRET=QIXalhOBH2bn4i22VC4Pc2e8wg/6mkBh0tRuKsO7hiE=
ALLOWED_ORIGINS=https://staging.your-domain.com
EMAIL_PROVIDER=disabled
RATE_LIMIT_MAX_REQUESTS=500
RATE_LIMIT_WINDOW_MS=900000
PRISMA_CLI_TELEMETRY_DISABLED=1
ENABLE_DEBUG_LOGS=true
ENABLE_TEST_FEATURES=true
```

### **Step 4: 儲存並重新部署**
1. 儲存所有環境變數變更
2. 等待 Zeabur 自動重新部署
3. 檢查部署日誌確認無錯誤

---

## 🎯 **變更對比表**

| 變數名稱 | ❌ 舊值 (有問題) | ✅ 新值 (修正後) | 說明 |
|---------|----------------|-----------------|------|
| `JWT_SECRET` | staging_1234... | Tr4q2KulnbpxWMsUneujJe... | 使用加密安全的密鑰 |
| `SMTP_USER` | test@example.com | **刪除** | 移除假值避免驗證錯誤 |
| `SMTP_PASS` | testpassword | **刪除** | 移除假值避免驗證錯誤 |
| `SMTP_HOST` | smtp.example.com | **刪除** | 移除假值避免驗證錯誤 |
| `NEXTAUTH_SECRET` | **缺失** | QIXalhOBH2bn4i22VC4Pc2e8wg... | 新增必需變數 |
| `ALLOWED_ORIGINS` | **缺失** | https://staging.your-domain.com | 新增 CORS 設定 |
| `EMAIL_PROVIDER` | **缺失** | disabled | 避免 SMTP 驗證錯誤 |

---

## ✅ **修正完成後驗證**

### **基本驗證**:
```bash
# 檢查 staging 網站存取
curl -I https://staging.your-domain.com

# 檢查 API 健康狀態
curl https://staging.your-domain.com/api/health

# 檢查 OAuth providers
curl https://staging.your-domain.com/api/auth/providers
```

### **預期結果**:
- ✅ 部署不再出現 SMTP 驗證錯誤
- ✅ 網站正常載入
- ✅ API 端點正常回應
- ✅ Google OAuth 登入功能正常

---

## 🔐 **安全性改進**

### **新密鑰的優勢**:
1. **JWT_SECRET**: 使用 crypto.randomBytes(32) 生成，符合安全標準
2. **NEXTAUTH_SECRET**: 同樣使用強加密生成，長度充足
3. **完全隔離**: 與 development/production 環境密鑰完全不同

### **SMTP 問題解決**:
1. **移除假值**: 刪除所有 SMTP_* 假配置
2. **設定 disabled**: EMAIL_PROVIDER=disabled 跳過驗證
3. **避免部署失敗**: 不會觸發「SMTP configuration incomplete」錯誤

---

## 🚨 **立即行動項目**

### **Priority 1 (立即執行)**:
1. 登入 Zeabur 控制台
2. 找到您的 staging 服務
3. 刪除所有 `SMTP_*` 變數
4. 更新 `JWT_SECRET` 為新值
5. 添加所有缺失的變數

### **Priority 2 (確認結果)**:
1. 等待重新部署完成
2. 測試網站和 API 存取
3. 驗證 OAuth 登入功能

---

## 📞 **如果遇到問題**

### **常見錯誤與解決**:
1. **Environment validation failed** → 確認已添加 `EMAIL_PROVIDER=disabled`
2. **JWT verification failed** → 確認新的 JWT_SECRET 已正確設定
3. **OAuth redirect error** → 確認 NEXTAUTH_URL 域名正確

### **技術支援**:
- 參考 `STAGING-ENV-VARS-CONFIG.md` 詳細指南
- 檢查 Zeabur 部署日誌中的具體錯誤訊息

---

**🎯 完成這些修正後，您的 staging 環境將安全且穩定運行！**

*Generated by Claude Code - Staging Environment Variables Correction Guide | v1.0.0*