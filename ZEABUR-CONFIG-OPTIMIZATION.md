# 🚨 ZEABUR 環境變數優化指南
## Critical Environment Configuration Fix

**狀態**: URGENT - 需要立即修復  
**影響**: OAuth登入、數據庫連接、系統安全  
**預估時間**: 10-15分鐘  

---

## 📊 **當前配置問題分析**

### **❌ 發現的嚴重問題:**

1. **數據庫配置錯誤**
   ```env
   # 當前錯誤配置
   DATABASE_URL=postgres://user:password@localhost:5432/db
   ```
   - ❌ 指向 localhost 而非 Zeabur PostgreSQL
   - ❌ 使用測試憑證，無法連接生產數據庫

2. **安全密鑰不當**
   ```env
   # 當前不安全配置
   JWT_SECRET=1234567890abcdefghijklmnopqrstuvwxyz123456
   ```
   - ❌ 使用簡單的測試密鑰
   - ❌ 不符合生產環境安全標準

3. **缺少關鍵環境變數**
   - ❌ 無 `NEXTAUTH_URL` - 導致 OAuth 回調錯誤
   - ❌ 無 `NEXTAUTH_SECRET` - NextAuth 無法正常運作
   - ❌ 無 `ALLOWED_ORIGINS` - CORS 配置缺失

4. **郵件服務配置無效**
   ```env
   # 當前測試配置
   SMTP_HOST=smtp.example.com
   SMTP_USER=test@example.com
   SMTP_PASS=testpassword
   ```
   - ❌ 使用示例配置，無法發送實際郵件

---

## ✅ **建議的完整生產配置**

### **🔧 立即需要更新的環境變數:**

```env
# ==========================================
# 基礎應用配置 (CRITICAL)
# ==========================================
NODE_ENV=production
NEXTAUTH_URL=https://kcislk-infohub.zeabur.app
NEXTAUTH_SECRET=WtDE420rcUJjy7S1Fz6i2+Sksp/gHDq1v7wzkGSRqsE=

# ==========================================
# 數據庫配置 (CRITICAL)
# ==========================================
DATABASE_URL=postgresql://root:p356lGH1k4Kd7zefirJ0YSV8MC29ygON@tpe1.clusters.zeabur.com:32312/zeabur

# ==========================================
# 認證與安全配置 (CRITICAL)
# ==========================================
JWT_SECRET=yVVJWVI6c3VjLKY0X6vNnaTRJVxHHu1zEvYaYWvwAAI=
GOOGLE_CLIENT_ID=YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=YOUR_GOOGLE_CLIENT_SECRET

# ==========================================
# CORS 與安全限制 (CRITICAL)
# ==========================================
ALLOWED_ORIGINS=https://kcislk-infohub.zeabur.app
RATE_LIMIT_MAX_REQUESTS=100
RATE_LIMIT_WINDOW_MS=900000

# ==========================================
# 系統工具配置 (RECOMMENDED)
# ==========================================
PRISMA_CLI_TELEMETRY_DISABLED=1
```

---

## 🛠️ **更新步驟 - 按順序執行**

### **Step 1: 更新關鍵安全配置**

在 Zeabur 控制台依序更新以下變數：

1. **數據庫配置**
   ```
   DATABASE_URL = postgresql://root:p356lGH1k4Kd7zefirJ0YSV8MC29ygON@tpe1.clusters.zeabur.com:32312/zeabur
   ```

2. **NextAuth 配置**
   ```
   NEXTAUTH_URL = https://kcislk-infohub.zeabur.app
   NEXTAUTH_SECRET = WtDE420rcUJjy7S1Fz6i2+Sksp/gHDq1v7wzkGSRqsE=
   ```

3. **JWT 安全密鑰**
   ```
   JWT_SECRET = yVVJWVI6c3VjLKY0X6vNnaTRJVxHHu1zEvYaYWvwAAI=
   ```

### **Step 2: 添加安全配置**

4. **CORS 配置**
   ```
   ALLOWED_ORIGINS = https://kcislk-infohub.zeabur.app
   ```

5. **速率限制**
   ```
   RATE_LIMIT_MAX_REQUESTS = 100
   RATE_LIMIT_WINDOW_MS = 900000
   ```

6. **系統配置**
   ```
   NODE_ENV = production
   PRISMA_CLI_TELEMETRY_DISABLED = 1
   ```

### **Step 3: 移除或暫停無效配置**

**暫時移除或註釋掉** (直到正確配置):
- `SMTP_HOST=smtp.example.com`  
- `SMTP_USER=test@example.com`
- `SMTP_PASS=testpassword`

---

## 🧪 **配置驗證步驟**

### **1. 重啟服務**
更新環境變數後，在 Zeabur 控制台重啟服務。

### **2. 驗證數據庫連接**
```bash
# 檢查數據庫健康狀態
curl https://kcislk-infohub.zeabur.app/api/health
```

### **3. 測試 OAuth 流程**
```bash
# 檢查 OAuth providers
curl https://kcislk-infohub.zeabur.app/api/auth/providers
```

### **4. 完整登入測試**
1. 訪問: `https://kcislk-infohub.zeabur.app/login`
2. 點擊 \"使用 Google 登入\"
3. 驗證是否正確重定向到生產域名
4. 確認登入成功

---

## 🔍 **預期修復結果**

### **修復前的問題:**
- ❌ OAuth 回調重定向到 localhost:3001
- ❌ Internal Server Error 在登入時
- ❌ 數據庫連接失敗
- ❌ 系統無法正常運作

### **修復後的狀態:**
- ✅ OAuth 正確重定向到 `kcislk-infohub.zeabur.app`
- ✅ 登入流程完全正常
- ✅ 數據庫連接穩定
- ✅ 安全配置符合生產標準
- ✅ 系統完全功能正常

---

## 🆘 **故障排除指南**

### **如果 OAuth 仍然失敗:**
1. **檢查 Google Console** - 確認重定向 URI 已更新
2. **清除瀏覽器快取** - 強制重新整理
3. **等待傳播時間** - Google OAuth 變更需要 5-10 分鐘

### **如果數據庫連接失敗:**
1. **檢查 DATABASE_URL** - 確認完全正確複製
2. **驗證網路連接** - Zeabur 到數據庫的連線
3. **檢查資料庫狀態** - 在 Zeabur 控制台確認數據庫運行中

### **如果仍有 Internal Server Error:**
1. **檢查 Zeabur 日誌** - 查看具體錯誤訊息
2. **驗證所有環境變數** - 確保沒有遺漏
3. **重啟服務** - 確保配置生效

---

## ⏰ **時間表與期望**

- **環境變數更新**: 5 分鐘
- **服務重啟**: 2-3 分鐘  
- **配置生效時間**: 2-5 分鐘
- **Google OAuth 傳播**: 5-10 分鐘
- **完整測試驗證**: 5 分鐘

**總預估時間**: 15-20 分鐘

---

## 📞 **技術支援資訊**

如果在配置過程中遇到問題：

1. **檢查 Zeabur 服務日誌**
2. **查看瀏覽器開發者工具網路標籤**
3. **參考 `CRITICAL-OAUTH-FIX-GUIDE.md`**
4. **使用提供的 curl 命令測試端點**

---

**🔥 CRITICAL: 這些配置更新是解決 OAuth 登入問題的關鍵！**

*Generated by Claude Code - Zeabur Configuration Optimization Guide*